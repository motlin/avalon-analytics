// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  runtime  = "cloudflare"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String      @id @default(uuid()) // User ID (UUID-based)
  username    String      @unique
  createdAt   DateTime

  credentials Credential[] // Relationship: One user can have many credentials
}

model Credential {
  id            String   @id @default(uuid()) // Internal DB ID
  userId        String   @unique // Every credential is linked to a specific user
  user          User     @relation(fields: [userId], references: [id])
  createdAt     DateTime
  credentialId  String   @unique // WebAuthn credential identifier
  publicKey     Bytes
  counter       Int      @default(0)

  @@index([credentialId])
  @@index([userId])
}

model GameIngestionState {
  id                     Int      @id @default(1)
  lastIngestedGameTime   DateTime @default("1970-01-01T00:00:00Z")
  lastStatsProcessedTime DateTime @default("1970-01-01T00:00:00Z")
  updatedAt              DateTime @updatedAt
}

model RawGameData {
  firebaseKey String       @id
  gameJson    Json
  createdAt   DateTime
  playerGames PlayerGame[]

  @@index([createdAt])
}

model Person {
  id         String            @id @default(uuid())
  name       String            @unique
  createdAt  DateTime
  uids       PersonUid[]
  dateRanges PersonDateRange[]
  stats      PersonStats?

  @@index([name])
}

model PersonUid {
  id        String   @id @default(uuid())
  uid       String   @unique
  personId  String
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  createdAt DateTime

  @@index([uid])
  @@index([personId])
}

model PlayerGame {
  id          String      @id @default(uuid())
  playerUid   String
  firebaseKey String
  rawGameData RawGameData @relation(fields: [firebaseKey], references: [firebaseKey], onDelete: Cascade)
  createdAt   DateTime

  @@unique([playerUid, firebaseKey])
  @@index([playerUid])
  @@index([firebaseKey])
}

model PlayerStats {
  uid         String   @id
  name        String
  isMapped    Boolean
  gamesPlayed Int
  wins        Int
  goodGames   Int
  goodWins    Int
  evilGames   Int
  evilWins    Int
  createdAt   DateTime
  updatedAt   DateTime

  roleStats     PlayerRoleStats[]
  yearlyStats   PlayerYearlyStats[]
  lossReasons   PlayerLossReasons?
  merlinStats   PlayerMerlinStats?
  assassinStats PlayerAssassinStats?

  @@index([gamesPlayed(sort: Desc)])
}

model PlayerRoleStats {
  uid                   String
  player                PlayerStats @relation(fields: [uid], references: [uid], onDelete: Cascade)
  role                  String
  games                 Int
  wins                  Int
  losses                Int
  threeMissionFails     Int
  threeMissionSuccesses Int
  fiveRejectedProposals Int
  merlinAssassinated    Int
  wasAssassinated       Int

  @@id([uid, role])
}

model PlayerYearlyStats {
  uid       String
  player    PlayerStats @relation(fields: [uid], references: [uid], onDelete: Cascade)
  year      Int
  games     Int
  wins      Int
  goodGames Int
  goodWins  Int
  evilGames Int
  evilWins  Int

  @@id([uid, year])
}

model PlayerLossReasons {
  uid                     String      @id
  player                  PlayerStats @relation(fields: [uid], references: [uid], onDelete: Cascade)
  threeMissionFails       Int
  threeMissionSuccessEvil Int
  fiveRejectedProposals   Int
  merlinAssassinated      Int
}

model PlayerMerlinStats {
  uid                   String      @id
  player                PlayerStats @relation(fields: [uid], references: [uid], onDelete: Cascade)
  gamesPlayed           Int
  wins                  Int
  timesAssassinated     Int
  survivedAssassination Int
}

model PlayerAssassinStats {
  uid                      String      @id
  player                   PlayerStats @relation(fields: [uid], references: [uid], onDelete: Cascade)
  gamesPlayed              Int
  wins                     Int
  successfulAssassinations Int
  failedAssassinations     Int
}

model PersonStats {
  personId    String   @id
  person      Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  gamesPlayed Int
  wins        Int
  goodGames   Int
  goodWins    Int
  evilGames   Int
  evilWins    Int
  createdAt   DateTime
  updatedAt   DateTime

  roleStats     PersonRoleStats[]
  yearlyStats   PersonYearlyStats[]
  lossReasons   PersonLossReasons?
  merlinStats   PersonMerlinStats?
  assassinStats PersonAssassinStats?
}

model PersonRoleStats {
  personId              String
  personStats           PersonStats @relation(fields: [personId], references: [personId], onDelete: Cascade)
  role                  String
  games                 Int
  wins                  Int
  losses                Int
  threeMissionFails     Int
  threeMissionSuccesses Int
  fiveRejectedProposals Int
  merlinAssassinated    Int
  wasAssassinated       Int

  @@id([personId, role])
}

model PersonYearlyStats {
  personId  String
  personStats PersonStats @relation(fields: [personId], references: [personId], onDelete: Cascade)
  year      Int
  games     Int
  wins      Int
  goodGames Int
  goodWins  Int
  evilGames Int
  evilWins  Int

  @@id([personId, year])
}

model PersonLossReasons {
  personId                String      @id
  personStats             PersonStats @relation(fields: [personId], references: [personId], onDelete: Cascade)
  threeMissionFails       Int
  threeMissionSuccessEvil Int
  fiveRejectedProposals   Int
  merlinAssassinated      Int
}

model PersonMerlinStats {
  personId              String      @id
  personStats           PersonStats @relation(fields: [personId], references: [personId], onDelete: Cascade)
  gamesPlayed           Int
  wins                  Int
  timesAssassinated     Int
  survivedAssassination Int
}

model PersonAssassinStats {
  personId                 String      @id
  personStats              PersonStats @relation(fields: [personId], references: [personId], onDelete: Cascade)
  gamesPlayed              Int
  wins                     Int
  successfulAssassinations Int
  failedAssassinations     Int
}

model PersonDateRange {
  id        String   @id @default(uuid())
  personId  String
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  startDate String
  endDate   String?
  createdAt DateTime

  @@index([personId])
}
