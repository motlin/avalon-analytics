// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  runtime  = "cloudflare"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String      @id @default(uuid()) // User ID (UUID-based)
  username    String      @unique
  createdAt   DateTime

  credentials Credential[] // Relationship: One user can have many credentials
}

model Credential {
  id            String   @id @default(uuid()) // Internal DB ID
  userId        String   @unique // Every credential is linked to a specific user
  user          User     @relation(fields: [userId], references: [id])
  createdAt     DateTime
  credentialId  String   @unique // WebAuthn credential identifier
  publicKey     Bytes
  counter       Int      @default(0)

  @@index([credentialId])
  @@index([userId])
}

model GameIngestionState {
  id                     Int      @id @default(1)
  lastIngestedGameTime   DateTime @default("1970-01-01T00:00:00Z")
  lastStatsProcessedTime DateTime @default("1970-01-01T00:00:00Z")
  updatedAt              DateTime @updatedAt
}

model RawGameData {
  firebaseKey      String                 @id
  gameJson         Json
  createdAt        DateTime
  playerGames      PlayerGame[]
  annotationGames  PersonAnnotationGame[]

  @@index([createdAt])
}

model Person {
  id         String            @id @default(uuid())
  name       String            @unique
  createdAt  DateTime
  uids       PersonUid[]
  dateRanges PersonDateRange[]
  stats      PersonStats?

  @@index([name])
}

model PersonUid {
  id        String   @id @default(uuid())
  uid       String   @unique
  personId  String
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  createdAt DateTime

  @@index([uid])
  @@index([personId])
}

model PlayerGame {
  id          String      @id @default(uuid())
  playerUid   String
  firebaseKey String
  rawGameData RawGameData @relation(fields: [firebaseKey], references: [firebaseKey], onDelete: Cascade)
  createdAt   DateTime

  @@unique([playerUid, firebaseKey])
  @@index([playerUid])
  @@index([firebaseKey])
}

model PlayerStats {
  uid         String   @id
  name        String
  isMapped    Boolean
  gamesPlayed Int
  wins        Int
  goodGames   Int
  goodWins    Int
  evilGames   Int
  evilWins    Int
  createdAt   DateTime
  updatedAt   DateTime

  roleStats         PlayerRoleStats[]
  yearlyStats       PlayerYearlyStats[]
  lossReasons       PlayerLossReasons?
  merlinStats       PlayerMerlinStats?
  assassinStats     PlayerAssassinStats?
  evilTeammateStats PlayerEvilTeammateStats?

  @@index([gamesPlayed(sort: Desc)])
}

model PlayerRoleStats {
  uid                   String
  player                PlayerStats @relation(fields: [uid], references: [uid], onDelete: Cascade)
  role                  String
  games                 Int
  wins                  Int
  losses                Int
  threeMissionFails     Int
  threeMissionSuccesses Int
  fiveRejectedProposals Int
  merlinAssassinated    Int
  wasAssassinated       Int

  @@id([uid, role])
}

model PlayerYearlyStats {
  uid       String
  player    PlayerStats @relation(fields: [uid], references: [uid], onDelete: Cascade)
  year      Int
  games     Int
  wins      Int
  goodGames Int
  goodWins  Int
  evilGames Int
  evilWins  Int

  @@id([uid, year])
}

model PlayerLossReasons {
  uid                     String      @id
  player                  PlayerStats @relation(fields: [uid], references: [uid], onDelete: Cascade)
  threeMissionFails       Int
  threeMissionSuccessEvil Int
  fiveRejectedProposals   Int
  merlinAssassinated      Int
}

model PlayerMerlinStats {
  uid                   String      @id
  player                PlayerStats @relation(fields: [uid], references: [uid], onDelete: Cascade)
  gamesPlayed           Int
  wins                  Int
  timesAssassinated     Int
  survivedAssassination Int
}

model PlayerAssassinStats {
  uid                      String      @id
  player                   PlayerStats @relation(fields: [uid], references: [uid], onDelete: Cascade)
  gamesPlayed              Int
  wins                     Int
  successfulAssassinations Int
  failedAssassinations     Int
}

model PlayerEvilTeammateStats {
  uid                      String      @id
  player                   PlayerStats @relation(fields: [uid], references: [uid], onDelete: Cascade)
  gamesPlayed              Int
  wins                     Int
  successfulAssassinations Int
  failedAssassinations     Int
}

model PersonStats {
  personId    String   @id
  person      Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  gamesPlayed Int
  wins        Int
  goodGames   Int
  goodWins    Int
  evilGames   Int
  evilWins    Int
  createdAt   DateTime
  updatedAt   DateTime

  roleStats         PersonRoleStats[]
  yearlyStats       PersonYearlyStats[]
  lossReasons       PersonLossReasons?
  merlinStats       PersonMerlinStats?
  assassinStats     PersonAssassinStats?
  evilTeammateStats PersonEvilTeammateStats?
  annotationStats   PersonAnnotationStats[]
}

model PersonRoleStats {
  personId              String
  personStats           PersonStats @relation(fields: [personId], references: [personId], onDelete: Cascade)
  role                  String
  games                 Int
  wins                  Int
  losses                Int
  threeMissionFails     Int
  threeMissionSuccesses Int
  fiveRejectedProposals Int
  merlinAssassinated    Int
  wasAssassinated       Int

  @@id([personId, role])
}

model PersonYearlyStats {
  personId  String
  personStats PersonStats @relation(fields: [personId], references: [personId], onDelete: Cascade)
  year      Int
  games     Int
  wins      Int
  goodGames Int
  goodWins  Int
  evilGames Int
  evilWins  Int

  @@id([personId, year])
}

model PersonLossReasons {
  personId                String      @id
  personStats             PersonStats @relation(fields: [personId], references: [personId], onDelete: Cascade)
  threeMissionFails       Int
  threeMissionSuccessEvil Int
  fiveRejectedProposals   Int
  merlinAssassinated      Int
}

model PersonMerlinStats {
  personId              String      @id
  personStats           PersonStats @relation(fields: [personId], references: [personId], onDelete: Cascade)
  gamesPlayed           Int
  wins                  Int
  timesAssassinated     Int
  survivedAssassination Int
}

model PersonAssassinStats {
  personId                 String      @id
  personStats              PersonStats @relation(fields: [personId], references: [personId], onDelete: Cascade)
  gamesPlayed              Int
  wins                     Int
  successfulAssassinations Int
  failedAssassinations     Int
}

model PersonEvilTeammateStats {
  personId                 String      @id
  personStats              PersonStats @relation(fields: [personId], references: [personId], onDelete: Cascade)
  gamesPlayed              Int
  wins                     Int
  successfulAssassinations Int
  failedAssassinations     Int
}

model PersonDateRange {
  id        String   @id @default(uuid())
  personId  String
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  startDate String
  endDate   String?
  createdAt DateTime

  @@index([personId])
}

model PersonAnnotationStats {
  id            String      @id @default(uuid())
  personId      String
  personStats   PersonStats @relation(fields: [personId], references: [personId], onDelete: Cascade)
  predicateName String
  fires         Int         @default(0)
  opportunities Int         @default(0)
  createdAt     DateTime
  updatedAt     DateTime    @updatedAt

  alignmentBreakdown PersonAnnotationAlignmentStats[]
  roleBreakdown      PersonAnnotationRoleStats[]
  gameInstances      PersonAnnotationGame[]

  @@unique([personId, predicateName])
  @@index([predicateName])
}

model PersonAnnotationAlignmentStats {
  id                String                @id @default(uuid())
  annotationStatsId String
  annotationStats   PersonAnnotationStats @relation(fields: [annotationStatsId], references: [id], onDelete: Cascade)
  alignment         String
  fires             Int                   @default(0)
  opportunities     Int                   @default(0)

  @@unique([annotationStatsId, alignment])
}

model PersonAnnotationRoleStats {
  id                String                @id @default(uuid())
  annotationStatsId String
  annotationStats   PersonAnnotationStats @relation(fields: [annotationStatsId], references: [id], onDelete: Cascade)
  role              String
  fires             Int                   @default(0)
  opportunities     Int                   @default(0)

  @@unique([annotationStatsId, role])
}

model PersonAnnotationGame {
  id                String                @id @default(uuid())
  annotationStatsId String
  annotationStats   PersonAnnotationStats @relation(fields: [annotationStatsId], references: [id], onDelete: Cascade)
  firebaseKey       String
  rawGameData       RawGameData           @relation(fields: [firebaseKey], references: [firebaseKey], onDelete: Cascade)
  fired             Boolean
  role              String
  missionNumber     Int?
  proposalNumber    Int?
  createdAt         DateTime

  @@unique([annotationStatsId, firebaseKey])
  @@index([firebaseKey])
  @@index([fired])
}

model GlobalAnnotationBaseline {
  predicateName      String   @id
  totalFires         Int      @default(0)
  totalOpportunities Int      @default(0)
  mappedPeopleCount  Int      @default(0)
  goodFires          Int      @default(0)
  goodOpportunities  Int      @default(0)
  evilFires          Int      @default(0)
  evilOpportunities  Int      @default(0)
  updatedAt          DateTime @updatedAt

  roleBaselines GlobalAnnotationRoleBaseline[]
}

model GlobalAnnotationRoleBaseline {
  id            String                   @id @default(uuid())
  predicateName String
  baseline      GlobalAnnotationBaseline @relation(fields: [predicateName], references: [predicateName], onDelete: Cascade)
  role          String
  fires         Int                      @default(0)
  opportunities Int                      @default(0)

  @@unique([predicateName, role])
}
